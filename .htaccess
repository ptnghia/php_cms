## Bật chế độ RewriteEngine
RewriteEngine On

## Chặn truy cập trực tiếp vào file cấu hình nhạy cảm
<FilesMatch "(?i)(^\.htaccess$|^\.env$|^\.git|composer\.json|composer\.lock|package\.json|package-lock\.json|yarn\.lock)">
    Order allow,deny
    Deny from all
</FilesMatch>

## Chặn liệt kê thư mục
Options -Indexes

## Chặn truy cập vào các thư mục hệ thống
# Cho phép .well-known, chặn các thư mục ẩn khác
RedirectMatch 403 /(?!\.well-known)[\.].*
RedirectMatch 403 /(vendor|storage|logs)/

# Chặn tất cả đường dẫn bắt đầu bằng /wp
RedirectMatch 403 ^/wp.*

## Chặn truy cập vào thư mục logs và các file trong đó
RedirectMatch 403 ^/log(/.*)?$

<FilesMatch "\.(log|txt)$">
    Require all denied
</FilesMatch>

## Chặn thực thi file .ini
<FilesMatch "\.ini$">
    Order allow,deny
    Deny from all
</FilesMatch>

## Chặn client độc hại
SetEnvIfNoCase User-Agent "(HTTrack|wget|nikto|sqlmap|acunetix|curl|java|python|perl|scan|bot)" bad_bot
Deny from env=bad_bot

## Chặn truy cập bằng phương thức curl
RewriteCond %{HTTP_USER_AGENT} ^curl [NC]
RewriteRule .* - [F,L]

# Bảo vệ chống DoS cơ bản
<IfModule mod_evasive20.c>
  DOSHashTableSize 3097
  DOSPageCount 20
  DOSSiteCount 150
  DOSPageInterval 1
  DOSSiteInterval 1
  DOSBlockingPeriod 60
</IfModule>

## Chỉ cho phép phương thức GET và POST và HEAD
  RewriteCond %{REQUEST_METHOD} !^(GET|POST|HEAD) [NC]
  RewriteRule .* - [F,L]

## Bật Gzip
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
</IfModule>

## Bật cache trình duyệt
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/html "access plus 1 hour"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
</IfModule>

## Bảo vệ chống clickjacking
Header always set X-Frame-Options "SAMEORIGIN"

## Bảo vệ chống XSS
Header set X-XSS-Protection "1; mode=block"

## Bảo vệ chống chèn nội dung không an toàn
#Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; object-src 'none';"

## Bảo vệ chống tải tài nguyên từ các trang không tin cậy
Header always set X-Content-Type-Options "nosniff"

## Bảo vệ chống tấn công MIME-Sniffing
Header set X-Content-Type-Options "nosniff"

## Buộc sử dụng HTTPS
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

## Chặn truy cập trực tiếp vào PHP trong thư mục cụ thể
<FilesMatch "^img_data/images/.*\.(php|php5|php7|php8)$">
    Require all denied
</FilesMatch>

## Giới hạn kích thước upload
php_value upload_max_filesize 10M
php_value post_max_size 12M

## Tắt hiển thị lỗi PHP
php_flag display_errors Off
php_flag log_errors On

## Bảo vệ chống Brute Force Attack
RewriteCond %{REQUEST_URI} ^/(wp-login.php|administrator) [NC]
RewriteCond %{HTTP:Authorization} ^$
RewriteRule .* - [R=429,L]

## Hạn chế số lượng kết nối từ một IP
<IfModule mod_ratelimit.c>
    SetEnvIf Request_URI ".*" RATE_LIMIT
    <Location />
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 10
    </Location>
</IfModule>

## Bảo vệ file SVG khỏi thực thi mã độc
<FilesMatch "\.svg$">
    Header always set Content-Type "image/svg+xml"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Content-Security-Policy "default-src 'self'; img-src 'self' data:; script-src 'none'; object-src 'none';"
</FilesMatch>

## Bảo vệ file config.php
<Files "config.php">
    Order allow,deny
    Deny from all
</Files>
<FilesMatch "^(robots\.txt|sitemap\.xml)$">
    Require all granted
</FilesMatch>

# url đa ngôn ngữ
RewriteRule ^([a-z]+)/$ index.php?com=&lang=$1 [L]
RewriteRule ^([a-z]+)/([a-zA-Z0-9_-]+).html$	index.php?lang=$1&com=$2 [L]
RewriteRule ^([a-z]+)/([a-zA-Z0-9_-]+).html&page=([0-9]+)$ index.php?lang=$1&com=$2&page=$3 [L]

# url một ngôn ngữ
#RewriteRule ^([^/]*).html$	index.php?com=$1 [L]
#RewriteRule ^([a-zA-Z0-9_-]+).html&page=([0-9]+)$ index.php?com=$1&page=$2 [L]

#RewriteRule ^([^/]*)/([^/]*).html$ index.php?alias=$1&com=$2 [L]
#RewriteRule ^([^/]*)/([^/]*).html(.*)$ index.php?alias=$1&com=$2&page=$3 [L]

#RewriteRule ^([^/]*)/([^/]*)/([^/]*).html$ index.php?alias=$1&alias1=$2&com=$3 [L]
#RewriteRule ^([^/]*)/([^/]*)/([^/]*).html(.*)$ index.php?alias=$1&alias1=$2&com=$3&page=$4 [L]
